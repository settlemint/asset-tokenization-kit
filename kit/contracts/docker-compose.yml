services:
  besu:
    image: hyperledger/besu:25.6.0
    container_name: atk-besu
    restart: unless-stopped
    command: ["--config-file=/opt/besu/config.toml", "--identity=atk"]
    volumes:
      - ./tools/docker/besu/config.toml:/opt/besu/config.toml:ro
      - ./tools/docker/besu/genesis.json:/opt/besu/genesis.json:ro
      - ./tools/docker/besu/anvil-test-key:/opt/besu/key:ro

  txsigner:
    image: ghcr.io/settlemint/btp-signer:7.13.0
    container_name: atk-txsigner
    restart: unless-stopped
    depends_on:
      besu:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      MODE: "standalone"
      RPC_ENDPOINT: "http://besu:8545"
      DB_CONNECTION_STRING: "postgresql://${TXSIGNER_DB_USER:-txsigner}:${TXSIGNER_DB_PASSWORD:-txsigner}@postgres:5432/${TXSIGNER_DB_NAME:-txsigner}?sslmode=disable"
      PRIVATE_KEY_MNEMONIC:
        ${PRIVATE_KEY_MNEMONIC:-"gate yellow grunt wrestle disease obtain mixed
        nature mansion tape purchase awful"}
      PRIVATE_KEY_DERIVATION_PATH: "m/44'/60'/0'/0/0"
      TX_SIGNER_PORT: 3000
      TX_SIGNER_METRICS_PORT: 3001
      TX_SIGNER_RPC_URL: "http://besu:8545"
      TX_SIGNER_CHAIN_ID: ${CHAIN_ID:-1337}
      TX_SIGNER_LOG_LEVEL: ${LOG_LEVEL:-info}
      TX_SIGNER_DEBUG: ${DEBUG:-false}
      TX_SIGNER_SIGNING_STRATEGY: local
      DATABASE_URL: "postgresql://${TXSIGNER_DB_USER:-txsigner}:${TXSIGNER_DB_PASSWORD:-txsigner}@postgres:5432/${TXSIGNER_DB_NAME:-txsigner}?sslmode=disable"
      TX_SIGNER_RATE_LIMIT_ENABLED: true
      TX_SIGNER_RATE_LIMIT_MAX_REQUESTS_PER_MINUTE: ${RATE_LIMIT_PER_MINUTE:-60}
      TX_SIGNER_RATE_LIMIT_MAX_REQUESTS_PER_HOUR: ${RATE_LIMIT_PER_HOUR:-1000}
      TX_SIGNER_QUEUE_MAX_SIZE: ${QUEUE_MAX_SIZE:-1000}
      TX_SIGNER_QUEUE_PROCESSING_INTERVAL: ${QUEUE_PROCESSING_INTERVAL:-1000}
      TX_SIGNER_GAS_PRICE_STRATEGY: ${GAS_PRICE_STRATEGY:-estimator}
      TX_SIGNER_GAS_FIXED_PRICE: ${GAS_FIXED_PRICE:-20}
      TX_SIGNER_GAS_LIMIT: ${GAS_LIMIT:-9007199254740991}
      TX_SIGNER_GAS_MULTIPLIER: ${GAS_MULTIPLIER:-1.1}
      TX_SIGNER_NONCE_STRATEGY: sequential
      TX_SIGNER_NONCE_MAX_PENDING: ${NONCE_MAX_PENDING:-10}
      TX_SIGNER_AUDIT_ENABLED: true
      TX_SIGNER_AUDIT_RETENTION_DAYS: ${AUDIT_RETENTION_DAYS:-30}
      TX_SIGNER_CORS_ENABLED: ${CORS_ENABLED:-false}
      TX_SIGNER_CORS_METHODS: ${CORS_METHODS:-GET,POST}
      TX_SIGNER_CORS_HEADERS: ${CORS_HEADERS:-Content-Type,Authorization}
    ports:
      - "8545:3000"

  postgres:
    image: postgres:17.5-alpine
    container_name: atk-postgres
    restart: unless-stopped
    command:
      [
        "postgres",
        "-cshared_preload_libraries=pg_stat_statements",
        "-cmax_connections=200",
        "-clog_statement=none",
        "-clog_duration=off",
        "-clog_min_duration_statement=1000",
      ]
    volumes:
      - ./tools/docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
      PGDATA: "/var/lib/postgresql/data"
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-postgres}",
        ]
      interval: 2s
      timeout: 2s
      retries: 5
      start_period: 5s

  portal:
    image: ghcr.io/settlemint/btp-scs-portal:8.5.6
    container_name: atk-portal
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./portal:/abis:ro
    environment:
      BLOCKCHAIN_JSON_RPC_ENDPOINT: http://txsigner:8545
      BLOCKCHAIN_NETWORK_ID: "${CHAIN_ID:-1337}"
      BLOCKCHAIN_NETWORK_NAME: ${NETWORK_NAME:-ATK}
      CONTRACT_ABI_PATH: /abis
      GRAPHQL_PORT: "7001"
      PORT: "7000"
      POSTGRES_CONNECTION_STRING: postgresql://${PORTAL_DB_USER:-portal}:${PORTAL_DB_PASSWORD:-portal}@postgres:5432/${PORTAL_DB_NAME:-portal}?sslmode=disable
      REDIS_HOST: redis
      REDIS_PASSWORD: ${REDIS_PASSWORD:-shared}
      REDIS_PORT: "6379"
      REDIS_USERNAME: ${REDIS_USERNAME:-default}
    ports:
      - "7000:7000"
      - "7001:7001"

  redis:
    image: redis:8.0-alpine
    container_name: atk-redis
    restart: unless-stopped
    command:
      redis-server --requirepass ${REDIS_PASSWORD:-shared} --save 60 1
      --loglevel warning --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test:
        [
          "CMD",
          "redis-cli",
          "--no-auth-warning",
          "-a",
          "${REDIS_PASSWORD:-shared}",
          "ping",
        ]
      interval: 2s
      timeout: 2s
      retries: 5
      start_period: 3s

  hasura:
    image: hasura/graphql-engine:v2.46.0
    container_name: atk-hasura
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      HASURA_GRAPHQL_METADATA_DATABASE_URL: postgres://${HASURA_DB_USER:-hasura}:${HASURA_DB_PASSWORD:-hasura}@postgres:5432/hasura
      PG_DATABASE_URL: postgres://${HASURA_DB_USER:-hasura}:${HASURA_DB_PASSWORD:-hasura}@postgres:5432/hasura
      HASURA_GRAPHQL_ENABLE_CONSOLE: "true"
      HASURA_GRAPHQL_DEV_MODE: "true"
      HASURA_GRAPHQL_ENABLED_LOG_TYPES:
        startup, http-log, webhook-log, websocket-log, query-log
      HASURA_GRAPHQL_ADMIN_SECRET: ${HASURA_ADMIN_SECRET:-hasura}
    ports:
      - "8080:8080"

  graph-node:
    image: graphprotocol/graph-node:v0.39.1
    container_name: atk-graph-node
    restart: unless-stopped
    platform: linux/amd64
    depends_on:
      besu:
        condition: service_healthy
      postgres:
        condition: service_healthy
    ports:
      - "8000:8000" # GraphQL HTTP
      - "8001:8001" # Admin
      - "8020:8020" # Index Node
      - "8030:8030" # Query Node
      - "8040:8040" # Subgraph
    environment:
      postgres_host: postgres
      postgres_user: thegraph
      postgres_pass: thegraph
      postgres_db: thegraph
      ipfs: "https://ipfs.console.settlemint.com"
      ethereum: "settlemint:http://besu:8545"
      GRAPH_ETHEREUM_REQUEST_RETRIES: 10
      ETHEREUM_POLLING_INTERVAL: 1000
      GRAPH_IPFS_TIMEOUT: 60
      GRAPH_MAX_IPFS_FILE_BYTES: 52428800
      GRAPH_IPFS_REQUEST_RETRIES: 10

  minio:
    image: minio/minio:RELEASE.2025-05-24T17-08-30Z
    container_name: atk-minio
    restart: unless-stopped
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-miniominio}
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 2s
      timeout: 2s
      retries: 5
      start_period: 5s

  minio-setup:
    image: minio/mc:RELEASE.2025-05-21T01-59-54Z
    container_name: atk-minio-setup
    depends_on:
      minio:
        condition: service_healthy
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-miniominio}
      MINIO_SERVICE_ACCESS_KEY: ${MINIO_SERVICE_ACCESS_KEY:-atk-service}
      MINIO_SERVICE_SECRET: ${MINIO_SERVICE_SECRET:-atk-service-secret}
    entrypoint: ["/init.sh"]
    volumes:
      - ./tools/docker/minio/init.sh:/init.sh
    restart: "no"

  blockscout-backend:
    image: ghcr.io/blockscout/blockscout:8.1.1
    container_name: atk-blockscout-backend
    restart: unless-stopped
    command: |
      sh -c "bin/blockscout eval \"Elixir.Explorer.ReleaseTasks.create_and_migrate()\" && bin/blockscout start"
    environment:
      ETHEREUM_JSONRPC_VARIANT: besu
      ETHEREUM_JSONRPC_HTTP_URL: http://besu:8545/
      DATABASE_URL: postgresql://blockscout:blockscout@postgres:5432/blockscout
      ETHEREUM_JSONRPC_TRANSPORT: http
      ETHEREUM_JSONRPC_DISABLE_ARCHIVE_BALANCES: false
      ETHEREUM_JSONRPC_TRACE_URL: http://besu:8545/
      SECRET_KEY_BASE: 56NtB48ear7+wMSf0IQuWDAAazhpb31qyc7GiyspBP2vh7t5zlCsF5QDv76chXeN
      PORT: 4000
      COIN_NAME: ATK
      COIN: ATK
      DISABLE_MARKET: true
      POOL_SIZE: 80
      POOL_SIZE_API: 10
      ECTO_USE_SSL: false
      HEART_BEAT_TIMEOUT: 30
      ADMIN_PANEL_ENABLED: false
      API_V1_READ_METHODS_DISABLED: false
      API_V1_WRITE_METHODS_DISABLED: false
      API_GRAPHQL_ENABLED: true
      TXS_STATS_DAYS_TO_COMPILE_AT_INIT: 10
      COIN_BALANCE_HISTORY_DAYS: 90
      RE_CAPTCHA_DISABLED: true
      DECODE_NOT_A_CONTRACT_CALLS: true
      ACCOUNT_ENABLED: false
      NFT_MEDIA_HANDLER_ENABLED: false
    ports:
      - "4000:4000"

  blockscout-frontend:
    image: ghcr.io/blockscout/frontend:v2.0.3
    platform: linux/amd64
    restart: unless-stopped
    container_name: atk-blockscout-frontend
    environment:
      NEXT_PUBLIC_API_HOST: localhost:4000
      NEXT_PUBLIC_API_PROTOCOL: http
      NEXT_PUBLIC_NETWORK_NAME: Asset Tokenization Kit
      NEXT_PUBLIC_NETWORK_SHORT_NAME: ATK
      NEXT_PUBLIC_NETWORK_ID: 1337
      NEXT_PUBLIC_NETWORK_CURRENCY_NAME: Asset Tokenization Kit
      NEXT_PUBLIC_NETWORK_CURRENCY_SYMBOL: ATK
      NEXT_PUBLIC_NETWORK_CURRENCY_DECIMALS: 18
      NEXT_PUBLIC_API_BASE_PATH: /
      NEXT_PUBLIC_APP_HOST: localhost:4000
      NEXT_PUBLIC_APP_PROTOCOL: http
      NEXT_PUBLIC_HOMEPAGE_CHARTS: "['daily_txs']"
      NEXT_PUBLIC_IS_TESTNET: false
      NEXT_PUBLIC_API_WEBSOCKET_PROTOCOL: ws
      NEXT_PUBLIC_API_SPEC_URL: https://raw.githubusercontent.com/blockscout/blockscout-api-v2-swagger/main/swagger.yaml
    ports:
      - "4001:3000"
