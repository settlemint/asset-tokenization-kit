apiVersion: v1
kind: Secret
metadata:
  name: {{ include "graph-node.pgSecretName" . }}
  labels:
    {{- include "graph-node.labels" . | nindent 4 }}
{{- $pgLocal := default (dict) .Values.postgresql -}}
{{- $pgConfig := ((include "atk.datastores.postgresql" (dict "context" $ "chartKey" "graphNode" "local" $pgLocal)) | fromYaml) | default (dict) -}}
{{- $pgUser := default "thegraph" (index $pgConfig "username") -}}
{{- $pgPassword := default "atk" (index $pgConfig "password") -}}
{{- $customSecret := default (dict) .Values.customSecret -}}
{{- $pgUserOverride := trim (default "" (index $customSecret "PGUSER")) -}}
{{- if ne $pgUserOverride "" }}
  {{- $pgUser = $pgUserOverride -}}
{{- end -}}
{{- $pgPasswordOverride := trim (default "" (index $customSecret "PGPASSWORD")) -}}
{{- if ne $pgPasswordOverride "" }}
  {{- $pgPassword = $pgPasswordOverride -}}
{{- end -}}
data:
  PGUSER: {{ $pgUser | b64enc }}
  PGPASSWORD: {{ $pgPassword | b64enc }}
