apiVersion: v1
kind: Secret
metadata:
  name: {{ include "common.names.fullname" . }}-env
  namespace: {{ include "common.names.namespace" . | quote }}
  labels: {{- include "common.labels.standard" ( dict "customLabels" .Values.commonLabels "context" $ ) | nindent 4 }}
  {{- if .Values.commonAnnotations }}
  annotations: {{- include "common.tplvalues.render" ( dict "value" .Values.commonAnnotations "context" $ ) | nindent 4 }}
  {{- end }}
type: Opaque
{{- $ctx := . -}}
{{- $postgresLocal := default (dict) .Values.postgresql -}}
{{- $postgresConfig := ((include "atk.datastores.postgresql" (dict "context" $ctx "chartKey" "txsigner" "local" $postgresLocal)) | fromYaml) | default (dict) -}}
{{- $postgresUrl := "" -}}
{{- if and $postgresConfig (hasKey $postgresConfig "url") -}}
  {{- $maybe := index $postgresConfig "url" -}}
  {{- if $maybe -}}
    {{- $postgresUrl = printf "%v" $maybe -}}
  {{- end -}}
{{- end -}}
{{- if eq (trim $postgresUrl) "" -}}
  {{- $postgresUrl = include "atk.datastores.postgresql.url" (dict "context" $ctx "chartKey" "txsigner" "local" $postgresLocal) -}}
{{- end }}
stringData:
  MODE: {{ .Values.config.mode | quote }}
  RPC_ENDPOINT: {{ .Values.config.rpcUrl | quote }}
  DB_CONNECTION_STRING: {{ $postgresUrl | quote }}
  {{- with .Values.config.extraSecretEnv }}
    {{- if ne (kindOf .) "map" }}
      {{- fail "config.extraSecretEnv must be a map of key/value pairs" }}
    {{- end }}
    {{- range $key, $value := . }}
{{- printf "%s: %s" $key (quote (tpl (printf "%v" $value) $ctx)) | nindent 2 }}
    {{- end }}
  {{- end }}
