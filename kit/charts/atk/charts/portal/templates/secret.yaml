apiVersion: v1
kind: Secret
metadata:
  name: {{ include "common.names.fullname" . }}
  namespace: {{ include "common.names.namespace" . | quote }}
  labels: {{- include "common.labels.standard" ( dict "customLabels" .Values.commonLabels "context" $ ) | nindent 4 }}
  {{- if .Values.commonAnnotations }}
  annotations: {{- include "common.tplvalues.render" ( dict "value" .Values.commonAnnotations "context" $ ) | nindent 4 }}
  {{- end }}
type: Opaque
{{- $ctx := . }}
{{- $postgresLocal := default (dict) .Values.config.postgresql }}
{{- $postgresConfig := ((include "atk.datastores.postgresql" (dict "context" $ctx "chartKey" "portal" "local" $postgresLocal)) | fromYaml) | default (dict) }}
{{- $postgresUrl := "" }}
{{- if and $postgresConfig (hasKey $postgresConfig "url") }}
  {{- $maybe := index $postgresConfig "url" -}}
  {{- if $maybe -}}
    {{- $postgresUrl = printf "%v" $maybe -}}
  {{- end -}}
{{- end -}}
{{- if eq (trim $postgresUrl) "" }}
  {{- $postgresUrl = include "atk.datastores.postgresql.url" (dict "context" $ctx "chartKey" "portal" "local" $postgresLocal) -}}
{{- end -}}
{{- $redisConfig := ((include "atk.datastores.redis" (dict "context" $ctx "chartKey" "portal" "local" (default (dict) .Values.config.redis))) | fromYaml) | default (dict) }}
{{- $redisHost := default "redis" (index $redisConfig "host") }}
{{- $redisPort := printf "%v" (default 6379 (index $redisConfig "port")) }}
{{- $redisUsername := default "default" (index $redisConfig "username") }}
{{- $redisPassword := default "atk" (index $redisConfig "password") }}
stringData:
  CONTRACT_ABI_PATH: "/abis"
  BLOCKCHAIN_NETWORK_ID: {{ .Values.config.network.networkId | quote }}
  BLOCKCHAIN_NETWORK_NAME: {{ .Values.config.network.networkName | quote }}
  BLOCKCHAIN_JSON_RPC_ENDPOINT: {{ .Values.config.network.nodeRpcUrl | quote }}
  POSTGRES_CONNECTION_STRING: {{ $postgresUrl | quote }}
  REDIS_HOST: {{ $redisHost | quote }}
  REDIS_PORT: {{ $redisPort | quote }}
  REDIS_USERNAME: {{ $redisUsername | quote }}
  REDIS_PASSWORD: {{ $redisPassword | quote }}
  PORT: {{ .Values.service.port | quote }}
  GRAPHQL_PORT: {{ .Values.service.graphqlPort | quote }}
