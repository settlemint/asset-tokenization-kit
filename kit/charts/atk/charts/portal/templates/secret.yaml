apiVersion: v1
kind: Secret
metadata:
  name: {{ include "common.names.fullname" . }}
  namespace: {{ include "common.names.namespace" . | quote }}
  labels: {{- include "common.labels.standard" ( dict "customLabels" .Values.commonLabels "context" $ ) | nindent 4 }}
  {{- if .Values.commonAnnotations }}
  annotations: {{- include "common.tplvalues.render" ( dict "value" .Values.commonAnnotations "context" $ ) | nindent 4 }}
  {{- end }}
type: Opaque
{{- $ctx := . }}
{{- $postgresLocal := default (dict) .Values.config.postgresql }}
{{- $postgresConfig := ((include "atk.datastores.postgresql" (dict "context" $ctx "chartKey" "portal" "local" $postgresLocal)) | fromYaml) | default (dict) }}
{{- $postgresExistingSecret := trim (default "" (index $postgresConfig "existingSecret")) }}
{{- $postgresUrl := "" -}}
{{- if eq $postgresExistingSecret "" }}
  {{- $postgresUrl = include "atk.datastores.postgresql.url" (dict "context" $ctx "chartKey" "portal" "local" $postgresLocal) -}}
{{- end }}
{{- $redisLocal := default (dict) .Values.config.redis -}}
{{- $redisConfig := ((include "atk.datastores.redis" (dict "context" $ctx "chartKey" "portal" "local" $redisLocal)) | fromYaml) | default (dict) -}}
{{- $redisExistingSecret := trim (default "" (index $redisConfig "existingSecret")) -}}
{{- $redisHost := "" -}}
{{- $redisPort := "" -}}
{{- $redisUsername := "" -}}
{{- $redisPassword := "" -}}
{{- if eq $redisExistingSecret "" -}}
  {{- $redisHost = trim (include "atk.redis.host" (dict "context" $ctx "chartKey" "portal" "local" $redisLocal)) -}}
  {{- $redisPort = trim (include "atk.redis.port" (dict "context" $ctx "chartKey" "portal" "local" $redisLocal)) -}}
  {{- $redisUsername = trim (include "atk.redis.username" (dict "context" $ctx "chartKey" "portal" "local" $redisLocal)) -}}
  {{- $redisPassword = trim (include "atk.redis.password" (dict "context" $ctx "chartKey" "portal" "local" $redisLocal)) -}}
{{- end -}}
{{- $networkId := trim (include "portal.networkId" .) }}
{{- $networkName := trim (include "portal.networkName" .) }}
stringData:
  CONTRACT_ABI_PATH: "/abis"
  BLOCKCHAIN_NETWORK_ID: {{ default "" $networkId | quote }}
  BLOCKCHAIN_NETWORK_NAME: {{ default "" $networkName | quote }}
  BLOCKCHAIN_JSON_RPC_ENDPOINT: {{ .Values.config.network.nodeRpcUrl | quote }}
  {{- if eq $postgresExistingSecret "" }}
  POSTGRES_CONNECTION_STRING: {{ $postgresUrl | quote }}
  {{- end }}
  {{- if eq $redisExistingSecret "" }}
  REDIS_HOST: {{ $redisHost | quote }}
  REDIS_PORT: {{ $redisPort | quote }}
  REDIS_USERNAME: {{ $redisUsername | quote }}
  REDIS_PASSWORD: {{ $redisPassword | quote }}
  {{- end }}
  PORT: {{ .Values.service.port | quote }}
  GRAPHQL_PORT: {{ .Values.service.graphqlPort | quote }}
